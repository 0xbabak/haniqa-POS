<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>haniqa — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&family=Bebas+Neue&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<style>
  .ch-btn {
    padding: 5px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.18s;
  }
  .ch-btn:hover { border-color: var(--pink-dim); color: var(--text); }
  .ch-btn.active { background: var(--pink); border-color: var(--pink); color: #0a0a09; font-weight: 500; }
  .date-input {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    border-radius: 2px;
    outline: none;
    color-scheme: dark;
  }
  .date-input:focus { border-color: var(--pink-dim); }
  .apply-btn {
    padding: 4px 10px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    border-radius: 2px;
  }
  .apply-btn:hover { border-color: var(--pink-dim); color: var(--pink); }
</style>
</head>
<body>

<!-- ── SIDEBAR ── -->
<nav class="sidebar">
  <div class="logo-block">
    <div class="logo">han<span class="pink-text">iq</span>a</div>
    <div class="logo-sub" style="color:var(--pink)">Retail Management System</div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Point of Sale</div>
    <div class="nav-item" onclick="window.location='pos.html'">
      <span class="nav-icon">◉</span> POS Terminal
    </div>
    <div class="nav-item" onclick="window.location='pos.html#cashier'">
      <span class="nav-icon">◪</span> Cash Register
    </div>
    <div class="nav-item" onclick="window.location='pos.html#sales'">
      <span class="nav-icon">◈</span> Sales
    </div>

    <div class="nav-divider"></div>
    <div class="nav-label">Insights</div>
    <div class="nav-item active" id="nav-dashboard" onclick="return false">
      <span class="nav-icon">◈</span> Dashboard
    </div>
    <div class="nav-item" onclick="window.location='ai.html'">
      <span class="nav-icon">◻</span> Analytics
    </div>
    <div class="nav-item" onclick="window.location='ai.html#ai-chat'">
      <span class="nav-icon">◎</span> Chat with AI
    </div>

    <div class="nav-divider"></div>
    <div class="nav-label">Catalogue</div>
    <div class="nav-item" onclick="window.location='catalogue.html'">
      <span class="nav-icon">◫</span> All Products
    </div>
    <div class="nav-item" onclick="window.location='catalogue.html#add'">
      <span class="nav-icon">+</span> Add Product
    </div>
  </div>

  <div class="sidebar-footer">
    <button class="theme-toggle" onclick="toggleTheme()">
      <span id="theme-icon">◐</span> <span id="theme-text">Light Mode</span>
    </button>
    <button class="theme-toggle" onclick="logout()" style="color: var(--red); margin-top: 6px">⇥ Sign Out</button>
  </div>
</nav>

<!-- ── MAIN ── -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-title">Dashboard</div>
    <div style="display:flex; gap:4px; align-items:center">
      <button class="ch-btn active" id="ch-both"       onclick="setChannel('both',this)">Both</button>
      <button class="ch-btn"        id="ch-wholesale"  onclick="setChannel('wholesale',this)">Wholesale</button>
      <button class="ch-btn"        id="ch-single"     onclick="setChannel('single',this)">Single</button>
    </div>
  </div>

  <!-- ════ DASHBOARD ════ -->
  <div class="page active" id="page-dashboard">
    <div class="highlight-bar"></div>
    <div style="padding: 28px 32px 0">

      <div class="section-head">
        <div class="section-title">Season at a Glance</div>
        <div class="section-line"></div>
        <div class="section-meta" id="channel-label">Both Channels · SS 2026</div>
      </div>

      <!-- KPIs -->
      <div class="dash-hero">
        <div class="kpi-card gold">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value">$<span id="kpi-rev">—</span><span class="unit">k</span></div>
          <div class="kpi-change" id="kpi-rev-sub">Loading…</div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-label">Total Units Sold</div>
          <div class="kpi-value"><span id="kpi-units">—</span></div>
          <div class="kpi-change" id="kpi-units-sub">Loading…</div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-label">Active SKUs</div>
          <div class="kpi-value"><span id="kpi-skus">—</span></div>
          <div class="kpi-change up">Total products in system</div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-label">Low Stock Items</div>
          <div class="kpi-value"><span id="kpi-low">—</span></div>
          <div class="kpi-change down">Below 20 units</div>
        </div>
      </div>

      <!-- Monthly Chart with date filter -->
      <div class="chart-card" style="margin-bottom: 24px">
        <div class="chart-header">
          <div>
            <div class="chart-title">Monthly Sales Performance</div>
            <div class="chart-subtitle" id="chart-sub">Revenue &amp; units · last 12 months</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <input type="date" id="date-from" class="date-input" title="From date">
            <span style="font-size:9px; color:var(--text-dim)">→</span>
            <input type="date" id="date-to" class="date-input" title="To date">
            <button class="apply-btn" onclick="applyDateFilter()">Apply</button>
            <button class="apply-btn" onclick="clearDateFilter()">Clear</button>
            <span style="width:1px; height:14px; background:var(--border); margin:0 4px"></span>
            <span style="font-size:9px; color:var(--pink)">● Revenue</span>
            <span style="font-size:9px; color:var(--accent)">● Units</span>
          </div>
        </div>
        <div class="chart-canvas-wrap">
          <canvas id="lineChart" height="200"></canvas>
        </div>
      </div>

      <!-- Top Sellers -->
      <div class="table-card" style="margin-bottom:40px">
        <div class="table-header">
          <div class="table-title">Top Performing Items</div>
          <div class="view-all" onclick="window.location='catalogue.html'">View All →</div>
        </div>
        <div class="table-head">
          <span>#</span>
          <span>Product</span>
          <span style="text-align:right">Price</span>
          <span style="text-align:right">Sold</span>
          <span style="text-align:right">Revenue</span>
          <span>Status</span>
        </div>
        <div id="top-sellers-body"></div>
      </div>

    </div>
  </div>

</div><!-- /main -->

<!-- ── PRODUCT DETAIL MODAL ── -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-box">
    <div class="modal-header">
      <div>
        <div style="font-size:9px; letter-spacing:0.25em; color:var(--pink-dim); text-transform:uppercase; margin-bottom:6px" id="modal-cat"></div>
        <div style="font-family:'Cormorant Garamond',serif; font-size:26px; font-weight:300; color:var(--text-bright)" id="modal-name"></div>
        <div style="font-size:11px; color:var(--text-dim); margin-top:2px" id="modal-ref"></div>
      </div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-img" id="modal-img"></div>
      <div class="modal-details" id="modal-details"></div>
    </div>
  </div>
</div>

<script>
// ── AUTH ──
async function checkAuth() {
  const res = await fetch('/api/auth/me');
  if (!res.ok) { window.location.href = '/login.html'; throw new Error('unauth'); }
}
async function logout() {
  await fetch('/api/auth/logout', { method: 'POST' });
  sessionStorage.clear();
  window.location.href = '/login.html';
}

// ── THEME ──
function toggleTheme() {
  document.body.classList.toggle('light-theme');
  const isLight = document.body.classList.contains('light-theme');
  document.getElementById('theme-icon').textContent = isLight ? '◑' : '◐';
  document.getElementById('theme-text').textContent = isLight ? 'Dark Mode' : 'Light Mode';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
}
function loadTheme() {
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-theme');
    document.getElementById('theme-icon').textContent = '◑';
    document.getElementById('theme-text').textContent = 'Dark Mode';
  }
}

// ── STATE ──
let products        = [];
let MONTHS          = [];
let MONTHLY_UNITS   = [];
let MONTHLY_REVENUE = [];
let currentChannel  = 'both';

// ── CHANNEL TOGGLE ──
function setChannel(ch, el) {
  currentChannel = ch;
  document.querySelectorAll('.ch-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const labels = { both: 'Both Channels', wholesale: 'Wholesale', single: 'Single / Retail' };
  document.getElementById('channel-label').textContent = (labels[ch] || ch) + ' · SS 2026';
  loadDashboard();
}

// ── DATE FILTER ──
function applyDateFilter() {
  const from = document.getElementById('date-from').value;
  const to   = document.getElementById('date-to').value;
  const sub  = from || to
    ? `Revenue & units · ${from || '…'} → ${to || '…'}`
    : 'Revenue & units · last 12 months';
  document.getElementById('chart-sub').textContent = sub;
  loadDashboard();
}
function clearDateFilter() {
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value   = '';
  document.getElementById('chart-sub').textContent = 'Revenue & units · last 12 months';
  loadDashboard();
}

// ── LINE CHART ──
function drawLine() {
  const canvas = document.getElementById('lineChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W   = canvas.parentElement.offsetWidth;
  canvas.width  = W;
  canvas.height = 200;

  if (MONTHS.length === 0) {
    ctx.clearRect(0, 0, W, 200);
    ctx.fillStyle = '#555550';
    ctx.font      = '11px DM Mono';
    ctx.textAlign = 'center';
    ctx.fillText('No sales recorded yet', W / 2, 100);
    return;
  }

  const pad  = { l: 52, r: 20, t: 16, b: 36 };
  const iW   = W - pad.l - pad.r;
  const iH   = 200 - pad.t - pad.b;
  ctx.clearRect(0, 0, W, 200);

  const steps  = 5;
  const maxRev = Math.max(...MONTHLY_REVENUE, 0.1) * 1.1;
  const maxU   = Math.max(...MONTHLY_UNITS, 1) * 1.1;
  const n      = MONTHS.length;

  // Grid + y-axis labels
  for (let i = 0; i <= steps; i++) {
    const y = pad.t + iH - (i / steps) * iH;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y);
    ctx.strokeStyle = 'rgba(255,255,255,0.04)'; ctx.lineWidth = 1; ctx.stroke();
    ctx.fillStyle = '#555550'; ctx.font = '9px DM Mono'; ctx.textAlign = 'right';
    ctx.fillText('$' + ((i / steps) * maxRev).toFixed(1) + 'k', pad.l - 6, y + 3);
  }

  // X labels
  MONTHS.forEach((m, i) => {
    const x = pad.l + (i / Math.max(n - 1, 1)) * iW;
    ctx.fillStyle = '#555550'; ctx.font = '9px DM Mono'; ctx.textAlign = 'center';
    ctx.fillText(m, x, 200 - 8);
  });

  // Revenue fill
  ctx.beginPath();
  MONTHLY_REVENUE.forEach((v, i) => {
    const x = pad.l + (i / Math.max(n - 1, 1)) * iW;
    const y = pad.t + iH - (v / maxRev) * iH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  const revGrad = ctx.createLinearGradient(0, pad.t, 0, pad.t + iH);
  revGrad.addColorStop(0, 'rgba(255,105,180,0.25)');
  revGrad.addColorStop(1, 'rgba(255,105,180,0)');
  ctx.lineTo(pad.l + iW, pad.t + iH); ctx.lineTo(pad.l, pad.t + iH); ctx.closePath();
  ctx.fillStyle = revGrad; ctx.fill();

  // Revenue line
  ctx.beginPath();
  MONTHLY_REVENUE.forEach((v, i) => {
    const x = pad.l + (i / Math.max(n - 1, 1)) * iW;
    const y = pad.t + iH - (v / maxRev) * iH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#ff69b4'; ctx.lineWidth = 2; ctx.setLineDash([]); ctx.stroke();

  // Units line (dashed)
  ctx.beginPath();
  MONTHLY_UNITS.forEach((v, i) => {
    const x = pad.l + (i / Math.max(n - 1, 1)) * iW;
    const y = pad.t + iH - (v / maxU) * iH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#8fb8a0'; ctx.lineWidth = 1.5; ctx.setLineDash([4, 3]); ctx.stroke();
  ctx.setLineDash([]);

  // Dots on revenue
  MONTHLY_REVENUE.forEach((v, i) => {
    const x = pad.l + (i / Math.max(n - 1, 1)) * iW;
    const y = pad.t + iH - (v / maxRev) * iH;
    ctx.beginPath(); ctx.arc(x, y, 3.5, 0, Math.PI * 2);
    ctx.fillStyle = '#ff69b4'; ctx.fill();
  });
}

// ── TOP SELLERS ──
const PTNS   = ['pattern-1','pattern-2','pattern-3','pattern-4','pattern-5','pattern-6'];
const PCOLRS = ['#3d2a1e','#1e3d2a','#1e2a3d','#3d3d1e','#2a1e3d','#3d1e2a'];

function buildTopSellers(topProds) {
  const sorted = topProds.slice(0, 8);
  const maxSold = sorted[0]?.sold || 1;
  const body = document.getElementById('top-sellers-body');
  body.innerHTML = sorted.map((p, i) => {
    const price = parseFloat(p.price);
    const rev   = parseFloat(p.revenue_total || p.revenue || 0);
    return `
    <div class="table-row" onclick="openModal(${p.id})">
      <div class="row-rank">${i + 1}</div>
      <div>
        <div class="row-name">${p.name}</div>
        <div class="row-code">${p.ref}</div>
      </div>
      <div class="row-num" style="text-align:right">$${price}</div>
      <div class="bar-cell">
        <div class="mini-bar-bg"><div class="mini-bar" style="width:${(p.sold / maxSold * 100).toFixed(0)}%"></div></div>
        <span style="font-size:11px; color:var(--text); min-width:32px; text-align:right">${p.sold}</span>
      </div>
      <div class="row-num positive" style="text-align:right">$${rev > 0 ? (rev / 1000).toFixed(1) + 'k' : (price * p.sold / 1000).toFixed(1) + 'k'}</div>
      <div><span class="badge ${p.status || 'new'}">${(p.status || 'new').toUpperCase()}</span></div>
    </div>`;
  }).join('');
}

// ── MODAL ──
function openModal(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  const cat   = p.category || '';
  const price = parseFloat(p.price);
  document.getElementById('modal-cat').textContent  = cat.toUpperCase();
  document.getElementById('modal-name').textContent = p.name;
  document.getElementById('modal-ref').textContent  = p.ref;
  const pi = products.indexOf(p);
  document.getElementById('modal-img').className = 'modal-img ' + PTNS[pi % 6];
  document.getElementById('modal-img').innerHTML = `
    <div class="product-color-chip" style="background:${PCOLRS[pi%6]}"></div>
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0.1">
      <svg width="80" height="110" viewBox="0 0 60 80" fill="none">
        <path d="M20 5 L5 20 L15 20 L15 70 L45 70 L45 20 L55 20 L40 5 Z" stroke="#888" stroke-width="1" fill="none"/>
      </svg>
    </div>`;
  const sold  = parseInt(p.sold)  || 0;
  const stock = parseInt(p.stock) || 0;
  const stPct = sold + stock > 0 ? Math.round(sold / (sold + stock) * 100) : 0;
  document.getElementById('modal-details').innerHTML = `
    <div class="detail-row"><span class="detail-label">Price</span><span class="detail-value" style="font-family:'Cormorant Garamond',serif;font-size:20px">$${price}</span></div>
    <div class="detail-row"><span class="detail-label">Units Sold</span><span class="detail-value" style="color:var(--accent)">${sold}</span></div>
    <div class="detail-row"><span class="detail-label">In Stock</span><span class="detail-value" ${stock < 20 ? 'style="color:var(--red)"' : ''}>${stock}</span></div>
    <div class="detail-row"><span class="detail-label">Revenue</span><span class="detail-value">$${(price * sold).toLocaleString()}</span></div>
    <div class="detail-row"><span class="detail-label">Status</span><span class="badge ${p.status || 'new'}">${(p.status || 'new').toUpperCase()}</span></div>
    <div class="detail-row"><span class="detail-label">Category</span><span class="detail-value" style="text-transform:capitalize">${cat}</span></div>
    <div style="margin-top:20px">
      <div class="kpi-label" style="margin-bottom:8px">Sell-through Rate</div>
      <div style="height:6px;background:var(--muted);border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${stPct}%;background:linear-gradient(90deg,var(--pink-dim),var(--pink));border-radius:3px"></div>
      </div>
      <div style="font-size:10px;color:var(--text-dim);margin-top:6px">${stPct}% sold through</div>
    </div>`;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(e) {
  if (!e || e.target === document.getElementById('modal-overlay'))
    document.getElementById('modal-overlay').classList.remove('open');
}

// ── LOAD DASHBOARD ──
async function loadDashboard() {
  const ch   = currentChannel;
  const from = document.getElementById('date-from').value;
  const to   = document.getElementById('date-to').value;

  let monthlyUrl = `/api/dashboard/monthly?channel=${ch}`;
  if (from) monthlyUrl += `&from=${from}`;
  if (to)   monthlyUrl += `&to=${to}`;

  try {
    const [statsRes, topRes, monthlyRes] = await Promise.all([
      fetch(`/api/dashboard/stats?channel=${ch}`),
      fetch(`/api/dashboard/top-sellers?channel=${ch}`),
      fetch(monthlyUrl),
    ]);
    const stats    = await statsRes.json();
    const topProds = await topRes.json();
    const monthly  = await monthlyRes.json();
    products = topProds;

    document.getElementById('kpi-rev').textContent      = (stats.totalRevenue / 1000).toFixed(1);
    document.getElementById('kpi-units').textContent    = stats.totalUnits.toLocaleString();
    document.getElementById('kpi-skus').textContent     = stats.activeSKUs;
    document.getElementById('kpi-low').textContent      = stats.lowStockCount;
    document.getElementById('kpi-rev-sub').textContent  = `Today: $${(stats.todaysSales||0).toFixed(0)}`;
    document.getElementById('kpi-units-sub').textContent = `Today: ${stats.todaysSalesCount||0} transactions`;

    MONTHS          = monthly.months;
    MONTHLY_UNITS   = monthly.units;
    MONTHLY_REVENUE = monthly.revenue;

    drawLine();
    buildTopSellers(topProds);
  } catch (err) {
    console.error('Dashboard load error:', err);
    drawLine();
  }
}

// ── INIT ──
window.addEventListener('load', async () => {
  await checkAuth();
  loadTheme();
  await loadDashboard();
});

window.addEventListener('resize', drawLine);
</script>
</body>
</html>
